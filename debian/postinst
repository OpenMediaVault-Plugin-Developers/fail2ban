#!/bin/sh
#
# This file is part of OpenMediaVault-fail2ban.
#
# @license   http://www.gnu.org/licenses/gpl.html GPL Version 3
# @author    OpenMediaVault Plugin Developers <plugins@omv-extras.org>
# @copyright Copyright (c) 2014 OpenMediaVault Plugin Developers
#
# OpenMediaVault is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# OpenMediaVault is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with OpenMediaVault. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

case "$1" in
    configure)
        echo "Initialize configuration"

        # Check for XML config
        if ! omv_config_exists "/config/services/fail2ban"; then
    	    echo "Initialize Fail2ban plugin configuration"
    	    DEFAULT_IGNOREIP="127.0.0.1"
    	    DEFAULT_BANTIME="600"
    	    DEFAULT_MAXRETRY="3"
    	    
            SSH_ENABLED="false"
            SSH_PORT="ssh"
            SSH_MAXRETRY="6"
            
            APACHE_ENABLED="false"
            APACHE_PORT="http,https"
            APACHE_MAXRETRY="6"

            PROFTPD_ENABLED="false"
            PROFTPD_PORT="ftp,ftp-data,ftps,ftps-data"
            PROFTPD_MAXRETRY="6"

        else
            echo "Importing previous configuration"
    	    DEFAULT_IGNOREIP="$(omv_config_get "/config/services/fail2ban/default/ignoreip")"
    	    DEFAULT_BANTIME="$(omv_config_get "/config/services/fail2ban/default/bantime")"
    	    DEFAULT_MAXRETRY="$(omv_config_get "/config/services/fail2ban/default/maxretry")"
    	    
            SSH_ENABLED="$(omv_config_get "/config/services/fail2ban/ssh/enabled")"
            SSH_PORT="$(omv_config_get "/config/services/fail2ban/ssh/port")"
            SSH_MAXRETRY="$(omv_config_get "/config/services/fail2ban/ssh/maxretry")"

            APACHE_ENABLED="$(omv_config_get "/config/services/fail2ban/apache/enabled")"
            APACHE_PORT="$(omv_config_get "/config/services/fail2ban/apache/port")"
            APACHE_MAXRETRY="$(omv_config_get "/config/services/fail2ban/apache/maxretry")"
            
            PROFTPD_ENABLED="$(omv_config_get "/config/services/fail2ban/proftpd/enabled")"
            PROFTPD_PORT="$(omv_config_get "/config/services/fail2ban/proftpd/port")"
            PROFTPD_MAXRETRY="$(omv_config_get "/config/services/fail2ban/proftpd/maxretry")"

        fi

        omv_config_delete "/config/services/fail2ban"
        
        object="<default>"
            object="${object}<ignoreip>${DEFAULT_IGNOREIP}</ignoreip>"
            object="${object}<bantime>${DEFAULT_BANTIME}</bantime>"
            object="${object}<maxretry>${DEFAULT_MAXRETRY}</maxretry>"
        object="${object}</default>"
        
        object="${object}<ssh>"
            object="${object}<enabled>${SSH_ENABLED}</enabled>"
            object="${object}<port>${SSH_PORT}</port>"
            object="${object}<maxretry>${SSH_MAXRETRY}</maxretry>"
        object="${object}</ssh>"
        
        object="${object}<apache>"
            object="${object}<enabled>${APACHE_ENABLED}</enabled>"
            object="${object}<port>${APACHE_PORT}</port>"
            object="${object}<maxretry>${APACHE_MAXRETRY}</maxretry>"
        object="${object}</apache>"

        object="${object}<proftpd>"
            object="${object}<enabled>${PROFTPD_ENABLED}</enabled>"
            object="${object}<port>${PROFTPD_PORT}</port>"
            object="${object}<maxretry>${PROFTPD_MAXRETRY}</maxretry>"
        object="${object}</proftpd>"

        omv_config_add_element "/config/services" "fail2ban" "${object}" true


        service fail2ban stop
        omv-mkconf fail2ban # Run script to update the configuration
        service fail2ban start


    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
